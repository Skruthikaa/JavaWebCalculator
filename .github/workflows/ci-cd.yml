name: CI/CD Pipeline - Java Web App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      NEXUS_URL: http://100.25.216.250:8081          # ‚ùå no trailing slash
      NEXUS_REPO: maven-releases
      NEXUS_GROUP: com/web/cal
      NEXUS_ARTIFACT: webapp-add
      TOMCAT_URL: http://50.16.12.7:8080/manager/text
      BUILD_VER: 0.0.${{ github.run_number }}

    steps:
    # --- Checkout Code ---
    - name: üì¶ Checkout Code
      uses: actions/checkout@v4

    # --- Setup Java 17 ---
    - name: ‚òï Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # --- Cache Maven Dependencies ---
    - name: üß∞ Cache Maven Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    # --- Run SonarQube Analysis ---
    - name: üîç SonarQube Analysis
      run: |
        mvn clean verify sonar:sonar \
          -DskipTests \
          -Dsonar.projectKey=JavaWebCalculator \
          -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
          -Dsonar.login=${{ env.SONAR_TOKEN }}
      continue-on-error: true

    # --- Build WAR File ---
    - name: ‚öôÔ∏è Build WAR Artifact
      run: |
        mvn clean package -DskipTests
        echo "‚úÖ Build complete!"
        ls -lh target/*.war

    # --- Upload WAR to Nexus ---
    - name: üì§ Upload WAR to Nexus Repository
      env:
        NEXUS_USER: ${{ secrets.NEXUS_USER }}
        NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
      run: |
        set -e
        WAR_FILE=$(ls target/*.war | head -1)
        VERSION=${{ env.BUILD_VER }}
        echo "üì¶ Uploading $WAR_FILE to Nexus version $VERSION ..."
        curl -v -u ${NEXUS_USER}:${NEXUS_PASS} --upload-file "$WAR_FILE" \
          "${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP }}/${{ env.NEXUS_ARTIFACT }}/${VERSION}/${{ env.NEXUS_ARTIFACT }}-${VERSION}.war"
        echo "‚úÖ WAR uploaded successfully to Nexus!"

    # --- Deploy WAR to Tomcat ---
    - name: üöÄ Deploy WAR to Tomcat
      env:
        TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
        TOMCAT_PASS: ${{ secrets.TOMCAT_PASS }}
        NEXUS_USER: ${{ secrets.NEXUS_USER }}
        NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
      run: |
        set -e
        APP_NAME="webapp-add"
        cd /tmp; rm -f *.war

        echo "üîç Fetching latest WAR from Nexus..."
        GROUP_DOTS=$(echo "${{ env.NEXUS_GROUP }}" | tr '/' '.')
        
        # Try up to 5 times (allowing Nexus time to index)
        for i in {1..5}; do
          echo "‚è≥ Attempt $i to get Nexus JSON..."
          RESPONSE=$(curl -s -u ${NEXUS_USER}:${NEXUS_PASS} \
            "${{ env.NEXUS_URL }}/service/rest/v1/search/assets?repository=${{ env.NEXUS_REPO }}&group=${GROUP_DOTS}&name=${{ env.NEXUS_ARTIFACT }}")
          
          if echo "$RESPONSE" | jq empty >/dev/null 2>&1; then
            DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r '.items[-1].downloadUrl // empty')
            if [ -n "$DOWNLOAD_URL" ]; then
              echo "‚úÖ Found WAR in Nexus: $DOWNLOAD_URL"
              break
            fi
          else
            echo "‚ö†Ô∏è Nexus returned invalid JSON (possibly still indexing)."
          fi
          
          echo "‚è≥ Waiting 15s before retry..."
          sleep 15
        done

        # Fallback if still empty
        if [ -z "$DOWNLOAD_URL" ]; then
          VERSION=${{ env.BUILD_VER }}
          DOWNLOAD_URL="${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP }}/${{ env.NEXUS_ARTIFACT }}/${VERSION}/${{ env.NEXUS_ARTIFACT }}-${VERSION}.war"
          echo "‚ö†Ô∏è Using fallback direct URL: $DOWNLOAD_URL"
        fi

        echo "‚¨áÔ∏è Downloading WAR from: $DOWNLOAD_URL"
        curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "$DOWNLOAD_URL"
        WAR_FILE=$(basename "$DOWNLOAD_URL")

        echo "üßπ Removing old app from Tomcat..."
        curl -u ${TOMCAT_USER}:${TOMCAT_PASS} "${{ env.TOMCAT_URL }}/undeploy?path=/${APP_NAME}" || true
        sleep 5

        echo "üöÄ Deploying new WAR to Tomcat..."
        curl -u ${TOMCAT_USER}:${TOMCAT_PASS} --upload-file "$WAR_FILE" \
          "${{ env.TOMCAT_URL }}/deploy?path=/${APP_NAME}&update=true"

        echo "‚úÖ Deployment completed successfully!"

    # --- Verify Deployment ---
    - name: üîé Verify Tomcat Deployment
      run: |
        sleep 15
        STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://50.16.12.7:8080/webapp-add/)
        if [ "$STATUS" -eq 200 ]; then
          echo "‚úÖ Application is LIVE at http://50.16.12.7:8080/webapp-add/"
        else
          echo "‚ö†Ô∏è Application returned HTTP $STATUS"
          exit 1
        fi
