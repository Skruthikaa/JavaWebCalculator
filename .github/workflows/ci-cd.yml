name: Java CI/CD - SonarQube, Nexus, Tomcat (Full Clean Deploy + Slack Alerts)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      NEXUS_URL: http://100.25.216.250:8081
      NEXUS_REPO: maven-releases
      NEXUS_GROUP: com/web/cal
      NEXUS_ARTIFACT: webapp-add
      TOMCAT_URL: http://50.16.12.7:8080/manager/text
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üß∞ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: üîç Run SonarQube Analysis
        run: |
          mvn clean verify sonar:sonar \
            -DskipTests \
            -Dsonar.projectKey=JavaWebCalculator \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.login=${{ env.SONAR_TOKEN }}

      - name: ‚öôÔ∏è Build WAR File
        run: |
          mvn clean package -DskipTests
          echo "‚úÖ Build completed!"
          ls -lh target/*.war

      - name: ‚¨ÜÔ∏è Upload WAR to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="0.0.${{ github.run_number }}"
          echo "üì¶ Uploading WAR to Nexus version $VERSION ..."
          curl -v -u ${NEXUS_USER}:${NEXUS_PASS} --upload-file "$WAR_FILE" \
            "${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP }}/${{ env.NEXUS_ARTIFACT }}/${VERSION}/${{ env.NEXUS_ARTIFACT }}-${VERSION}.war"
          echo "‚úÖ Uploaded successfully."

      - name: üöÄ Deploy WAR to Tomcat (Force Clean)
        env:
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
          TOMCAT_PASS: ${{ secrets.TOMCAT_PASS }}
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          set -e
          APP_NAME="webapp-add"
          cd /tmp; rm -f *.war

          echo "‚è≥ Waiting 10s for Nexus indexing..."
          sleep 10

          echo "üîç Fetching latest WAR from Nexus..."
          DOWNLOAD_URL=$(curl -s -u ${NEXUS_USER}:${NEXUS_PASS} \
            "${{ env.NEXUS_URL }}/service/rest/v1/search/assets?repository=${{ env.NEXUS_REPO }}&group=${{ env.NEXUS_GROUP }}&name=${{ env.NEXUS_ARTIFACT }}" \
            | jq -r '.items[-1].downloadUrl')

          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "‚ùå No WAR found for $APP_NAME in Nexus!"
            exit 1
          fi

          echo "‚¨áÔ∏è Downloading WAR: $DOWNLOAD_URL"
          curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "$DOWNLOAD_URL"
          WAR_FILE=$(basename "$DOWNLOAD_URL")

          echo "üßπ Undeploying old app..."
          curl -u ${TOMCAT_USER}:${TOMCAT_PASS} "${{ env.TOMCAT_URL }}/undeploy?path=/${APP_NAME}" || true
          sleep 5

          echo "üöÄ Deploying new WAR..."
          curl -u ${TOMCAT_USER}:${TOMCAT_PASS} --upload-file "$WAR_FILE" \
            "${{ env.TOMCAT_URL }}/deploy?path=/${APP_NAME}&update=true"

          echo "‚úÖ Deployment completed successfully!"

      - name: üîé Verify Deployment
        id: verify
        run: |
          sleep 15
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://98.81.123.228:8080/webapp-add/)
          if [ "$STATUS" -eq 200 ]; then
            echo "‚úÖ App is live with the latest code!"
          else
            echo "‚ö†Ô∏è App returned status $STATUS"
            exit 1
          fi

      - name: üí¨ Notify Slack - Deployment Success
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"‚úÖ Java WebApp successfully deployed to Tomcat! Build: '${{ github.run_number }}'"}' \
            ${{ env.SLACK_WEBHOOK_URL }}

      - name: üí¨ Notify Slack - Deployment Failed
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"‚ùå Deployment failed in workflow *'${{ github.workflow }}'*! Please check GitHub Actions logs."}' \
            ${{ env.SLACK_WEBHOOK_URL }}
